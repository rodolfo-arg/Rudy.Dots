# AGENTS

Last updated: 2026-01-22

## Workflow rules
- **Commit and push after each change**: After completing a logical change or fix, commit and push to remote. This ensures work is preserved and reviewable incrementally.
- **Run switch after config changes**: Always run `scripts/clean-nvim-and-switch` after modifying nvim config files.

## kotlin-android-lsp Plugin

A local Neovim plugin at `nvim/lua/kotlin-android-lsp/` providing Kotlin/Android/Java LSP support.

### Commands & Keymaps
- `<leader>dk` / `:KotlinWorkspaceGenerate` - Generate workspace.json for current project
- `<leader>di` / `:KotlinWorkspaceInfo` - Show workspace info (project type, versions, LSP status)
- `:checkhealth kotlin-android-lsp` - Health check for dependencies

### Plugin Modules
- `init.lua` - Main entry point, setup(), commands, keymaps
- `config.lua` - Configuration with defaults
- `uri.lua` - Bidirectional jar:/zipfile:// URI mapping
- `attach.lua` - LSP attachment for jar source buffers (both kotlin_lsp and jdtls)
- `workspace.lua` - Workspace generation with Gradle project detection
- `health.lua` - Health check module

### Project Detection
Parses `build.gradle`/`build.gradle.kts` to detect:
- Project type: Android, Kotlin JVM, Java, Mixed
- Versions: compileSdk, minSdk, Kotlin version, Java version
- Multi-module support

## LSP Configuration

### kotlin_lsp (JetBrains Kotlin LSP)
- Binary: `~/.nix-profile/bin/kotlin-lsp` (Nix-installed)
- Requires: Java 21+
- Filetypes: `kotlin`
- Workspace: Requires `workspace.json` generated by `<leader>dk`
- URI handling: Returns `jar:` URIs, converted to `zipfile://` for Neovim

### jdtls (Eclipse Java LSP)
- Binary: `~/.nix-profile/bin/jdtls` (Nix-installed via jdt-language-server)
- Requires: Java 21+
- Filetypes: `java`
- Single-file support: Enabled for zipfile:// buffers
- Root detection: Falls back to kotlin_lsp's root for jar sources
- URI handling: Uses `jdt://` URIs for its own content provider

### Known Limitations
- **Second-layer Java navigation**: kotlin_lsp indexes Java sources for Kotlin→Java navigation but doesn't fully support Java→Java navigation within libraries
- **jdtls in jar sources**: jdtls attaches to zipfile:// buffers but may not provide full navigation since it expects jdt:// URIs
- **Multiple editing sessions**: kotlin-lsp doesn't support multiple sessions; kill old processes before restarting

## Important Notes

### Treesitter
- Must not be lazy-loaded; keep `lazy = false` in its spec
- Auto-install enabled for kotlin, java, groovy parsers
- Headless install: `require('nvim-treesitter').install({ 'kotlin' }):wait(300000)`

### Workspace Generation
- Skipped unless `KOTLIN_LSP_PROJECT_ROOT` is set in switch script
- Or use `<leader>dk` interactively in Neovim
- Generates `workspace.json` and `kotlin-lsp-config.json` in project root
- Android SDK sources are packaged into `~/.cache/kotlin-lsp/android-sources/`

### URI Mapping
- `jar:file:///path.jar!/inner/File.kt` ↔ `zipfile:///path.jar::inner/File.kt`
- Bidirectional mapping in `kotlin-android-lsp/uri.lua`
- zipPlugin must stay enabled to open `zipfile://` buffers

### Mason
- Hybrid setup: Mason installed but auto-installs disabled
- Prefer Nix/PATH for LSP binaries
- Use Mason only for testing or when nixpkgs lacks a tool

### Debugging
- LSP log: `tail -f ~/.local/state/nvim/lsp.log`
- Kotlin LSP focused: `rg "kotlin-lsp|workspace.json|Error" ~/.local/state/nvim/lsp.log`
- Health check: `:checkhealth kotlin-android-lsp`
- Active clients: `:lua print(vim.inspect(vim.tbl_map(function(c) return c.name end, vim.lsp.get_clients())))`
